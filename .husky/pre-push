#!/bin/sh

# æŽ¨é€å‰æ‰§è¡Œæ›´é‡çš„æ ¡éªŒï¼ˆä¸¥æ ¼ï¼šå¤±è´¥åˆ™ç¦æ­¢ pushï¼‰
# è¯´æ˜Žï¼šè¦†ç›–çŽ‡é—¨æ§›æ”¾åˆ° CI å¼ºåˆ¶ï¼Œæœ¬åœ°åªä¿è¯â€œæµ‹è¯•é€šè¿‡â€ä¸Žâ€œç±»åž‹/æž„å»ºé€šè¿‡â€

set -eu

ROOT_DIR=$(git rev-parse --show-toplevel)
cd "$ROOT_DIR" || exit 1

# å°½é‡ç”¨ origin/main...HEAD åˆ¤æ–­æ˜¯å¦æ¶‰åŠå­é¡¹ç›®
BASE_REF="refs/remotes/origin/main"
if git show-ref --verify --quiet "$BASE_REF"; then
  DIFF_RANGE="origin/main...HEAD"
else
  # æ²¡æœ‰ origin/mainï¼ˆæ¯”å¦‚é¦–æ¬¡ clone æœª fetchï¼‰ï¼Œé€€åŒ–ä¸ºæ£€æŸ¥æœ€è¿‘ä¸€æ¬¡æäº¤
  DIFF_RANGE="HEAD~1...HEAD"
fi

changed_in_range() {
  git diff --name-only "$DIFF_RANGE" | grep -q "^$1/"
}

if changed_in_range "solacore-api"; then
  cd "$ROOT_DIR/solacore-api" || exit 1
  poetry run pytest -q --maxfail=1 --disable-warnings || exit 1
fi

if changed_in_range "solacore-web"; then
  printf '%s\n' "ðŸŒ æ£€æŸ¥ Webï¼šç±»åž‹æ£€æŸ¥ + Lint + æž„å»º" >&2
  cd "$ROOT_DIR/solacore-web" || exit 1
  npx tsc --noEmit || exit 1
  npm run lint || exit 1
  npm run build || exit 1
fi

if changed_in_range "solacore-mobile"; then
  printf '%s\n' "ðŸ“± æ£€æŸ¥ Mobileï¼šç±»åž‹æ£€æŸ¥ + Lint" >&2
  cd "$ROOT_DIR/solacore-mobile" || exit 1
  npx tsc --noEmit || exit 1
  npm run lint || exit 1
fi
