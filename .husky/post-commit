#!/bin/sh

# Post-commit: è‡ªåŠ¨æ¨é€ + è‡ªåŠ¨æ›´æ–° docs/PROGRESS.mdï¼ˆä¸¥æ ¼ç‰ˆï¼‰
# è¯´æ˜ï¼š
# - push ä¼šè§¦å‘ pre-pushï¼ˆæµ‹è¯•/ç±»å‹æ£€æŸ¥ï¼‰ï¼Œé€šè¿‡æ‰ä¼šæ¨é€æˆåŠŸ
# - æ›´æ–° PROGRESS.md åä¼šæŠŠå˜æ›´åˆå¹¶è¿›åˆšåˆšçš„ commitï¼ˆamendï¼‰
# - ä¸ºé¿å…æ— é™å¾ªç¯ï¼Œamend æ—¶ä¼šè®¾ç½® OPENCODE_POST_COMMIT=1

set -eu

if [ "${OPENCODE_POST_COMMIT:-}" = "1" ]; then
  exit 0
fi

ROOT_DIR=$(git rev-parse --show-toplevel)
cd "$ROOT_DIR" || exit 1

BRANCH=$(git branch --show-current 2>/dev/null || true)
if [ -z "$BRANCH" ]; then
  printf '%s\n' "âš ï¸  æ— æ³•è·å–å½“å‰åˆ†æ”¯ï¼Œè·³è¿‡è‡ªåŠ¨æ¨é€" >&2
  exit 0
fi

if ! git remote get-url origin >/dev/null 2>&1; then
  printf '%s\n' "âš ï¸  æœªé…ç½® origin è¿œç¨‹ä»“åº“ï¼Œè·³è¿‡è‡ªåŠ¨æ¨é€" >&2
  exit 0
fi

# é¿å…åœ¨ rebase/merge ä¸­è§¦å‘è‡ªåŠ¨åŒ–
if [ -d "$ROOT_DIR/.git/rebase-apply" ] || [ -d "$ROOT_DIR/.git/rebase-merge" ] || [ -f "$ROOT_DIR/.git/MERGE_HEAD" ]; then
  printf '%s\n' "âš ï¸  æ£€æµ‹åˆ° rebase/merge è¿›è¡Œä¸­ï¼Œè·³è¿‡è‡ªåŠ¨æ¨é€ä¸ PROGRESS æ›´æ–°" >&2
  exit 0
fi

printf '%s\n' "ğŸš€ è‡ªåŠ¨æ¨é€åˆ° origin/$BRANCH ..." >&2
if git push origin "$BRANCH" >/dev/null 2>&1; then
  printf '%s\n' "âœ… å·²æ¨é€åˆ° origin/$BRANCH" >&2
else
  if git push -u origin "$BRANCH" >/dev/null 2>&1; then
    printf '%s\n' "âœ… å·²æ¨é€åˆ° origin/$BRANCHï¼ˆé¦–æ¬¡å»ºç«‹ upstreamï¼‰" >&2
  else
    printf '%s\n' "âš ï¸  è‡ªåŠ¨æ¨é€å¤±è´¥ï¼ˆå¯èƒ½éœ€è¦å…ˆæ‹‰å–æˆ–è§£å†³å†²çªï¼‰ï¼Œè·³è¿‡ PROGRESS æ›´æ–°" >&2
    exit 0
  fi
fi

# ä»…åœ¨ push æˆåŠŸåè®°å½• PROGRESS
if [ ! -f "docs/PROGRESS.md" ]; then
  exit 0
fi

TIMESTAMP=$(date '+%Y-%m-%d %H:%M')
SUBJECT=$(git log -1 --pretty=%s | tr -d '\r')

python3 - "$TIMESTAMP" "$SUBJECT" <<'PY'
import sys
from pathlib import Path

timestamp = sys.argv[1]
subject = sys.argv[2]
progress_path = Path("docs/PROGRESS.md")

text = progress_path.read_text(encoding="utf-8")
entry = (
    f"\n### [{timestamp}] - è‡ªåŠ¨æäº¤\n\n"
    f"- [x] **å®Œæˆ**: {subject}\n"
    f"- [x] **æµ‹è¯•**: é€šè¿‡ âœ…\n"
    f"- [x] **æ¨é€**: å®Œæˆ\n\n"
    f"---\n"
)

marker = "---"
idx = text.find(marker)
if idx == -1:
    # æ²¡æœ‰åˆ†éš”çº¿æ—¶ï¼Œç›´æ¥è¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾
    new_text = text.rstrip() + "\n" + marker + entry
else:
    insert_at = idx + len(marker)
    new_text = text[:insert_at] + entry + text[insert_at:]

progress_path.write_text(new_text, encoding="utf-8")
PY

# å¦‚æœæ²¡æœ‰å®é™…å˜æ›´ï¼Œå°±ä¸åšäºŒæ¬¡æäº¤
git add docs/PROGRESS.md
if git diff --cached --quiet; then
  printf '%s\n' "ğŸ“ PROGRESS.md æ— å˜åŒ–ï¼Œè·³è¿‡" >&2
  exit 0
fi

# ä¸»åˆ†æ”¯é¿å…å¼ºæ¨ï¼šç”¨å•ç‹¬ commit
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
  printf '%s\n' "ğŸ“ æ›´æ–° PROGRESS.mdï¼ˆä¸»åˆ†æ”¯ï¼šåˆ›å»ºæ–° commitï¼Œä¸åš amend/force pushï¼‰" >&2
  OPENCODE_POST_COMMIT=1 git commit -m "docs(progress): update progress" --no-verify >/dev/null 2>&1 || true
  git push origin "$BRANCH" >/dev/null 2>&1 || true
  exit 0
fi

printf '%s\n' "ğŸ“ æ›´æ–° PROGRESS.md å¹¶åˆå¹¶è¿›æœ¬æ¬¡æäº¤ï¼ˆamendï¼‰" >&2
OPENCODE_POST_COMMIT=1 git commit --amend --no-edit --no-verify >/dev/null 2>&1

printf '%s\n' "ğŸš€ åŒæ­¥è¿œç«¯ï¼ˆforce-with-leaseï¼‰" >&2
OPENCODE_POST_COMMIT=1 git push origin "$BRANCH" --force-with-lease >/dev/null 2>&1

printf '%s\n' "âœ… PROGRESS.md å·²æ›´æ–°å¹¶åŒæ­¥" >&2
