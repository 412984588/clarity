name: ğŸ”§ Fix Production Database

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  fix-database:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fix production database
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "ğŸ”§ å¼€å§‹ä¿®å¤ç”Ÿäº§æ•°æ®åº“..."
            cd /home/linuxuser/solacore/solacore-api

            echo "ğŸ“Š æ£€æŸ¥å®¹å™¨çŠ¶æ€ï¼š"
            docker-compose -f docker-compose.prod.yml ps

            echo "ğŸ”„ é‡å¯æ•°æ®åº“å®¹å™¨..."
            docker-compose -f docker-compose.prod.yml restart db

            echo "â³ ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
            sleep 10

            echo "ğŸ”„ é‡å¯ API å®¹å™¨..."
            docker-compose -f docker-compose.prod.yml restart api

            echo "â³ ç­‰å¾… API å¯åŠ¨..."
            sleep 5

            echo "âœ… éªŒè¯ä¿®å¤ç»“æœï¼š"
            curl -s https://api.solacore.app/health | python3 -m json.tool || echo "API å°šæœªå°±ç»ªï¼Œè¯·ç­‰å¾… 30 ç§’åå†æ¬¡æ£€æŸ¥"

            echo "ğŸ“Š æœ€ç»ˆå®¹å™¨çŠ¶æ€ï¼š"
            docker-compose -f docker-compose.prod.yml ps

            echo "âœ… ä¿®å¤å®Œæˆï¼"

      - name: Notify completion
        run: |
          echo "âœ… æ•°æ®åº“ä¿®å¤æµç¨‹å·²æ‰§è¡Œ"
          echo "è¯·è®¿é—® https://api.solacore.app/health éªŒè¯ä¿®å¤ç»“æœ"
