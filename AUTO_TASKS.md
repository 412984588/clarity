# 🤖 自动任务清单 (Auto Tasks)

**生成时间**: 2025-12-25 04:00
**项目**: Clarity
**状态**: 全自动无人值守模式

---

## 📊 项目扫描结论

经过 Gemini 全量扫描 + 代码审计 + 测试验证，结论如下：

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 后端测试 | ✅ 106/106 PASSED | 17.56s 全绿 |
| 前端 Lint | ✅ 无警告 | ESLint 通过 |
| TypeScript | ✅ 无错误 | tsc --noEmit 通过 |
| Mypy 类型 | ✅ 40 文件无问题 | 类型安全 |
| TODO/FIXME | ✅ 0 个 | 代码质量极高 |

**核心判断：项目代码已 100% 完成，无功能性 Bug，仅有安全加固优化项**

---

## 🎯 可执行任务清单

基于 Gemini 的安全审计建议 + 代码质量优化，以下是可自动执行的任务：

### 优先级 P1 - 安全加固 (推荐)

| ID | 任务 | 文件 | 状态 |
|----|------|------|------|
| T1 | 加固内容过滤器 - 增强 Prompt Injection 防护 | `app/services/content_filter.py` | [x] Done |
| T2 | 加固设备限制 - 修复潜在并发竞态条件 | `app/services/auth_service.py` | [x] Done |
| T3 | 加固默认配置 - 确保生产环境不使用弱密钥 | `app/config.py` + `app/main.py` | [x] Done |

### 优先级 P2 - 代码质量 (可选)

| ID | 任务 | 文件 | 状态 |
|----|------|------|------|
| T4 | 添加更多边界测试用例 | `tests/` | [ ] Pending |
| T5 | 增加测试覆盖率到 90%+ | `tests/` | [ ] Pending |

### 优先级 P3 - 文档 (可选)

| ID | 任务 | 文件 | 状态 |
|----|------|------|------|
| T6 | 更新安全最佳实践文档 | `docs/` | [ ] Pending |

---

## 📝 任务详情

### T1: 加固内容过滤器 - 增强 Prompt Injection 防护

**问题**: `app/services/content_filter.py` 使用 Regex 进行内容过滤，可能被复杂的 Prompt Injection 攻击绕过

**解决方案**:
1. 增强 Regex 模式覆盖更多 injection 变体
2. 添加二次验证逻辑
3. 添加对应测试用例

**影响范围**: 仅后端服务层，不影响 API 接口

---

### T2: 加固设备限制 - 修复潜在并发竞态条件

**问题**: `AuthService._get_or_create_device` 在检查设备数量和插入新记录之间存在潜在竞态条件

**解决方案**:
1. 使用数据库级别的 CHECK 约束或 UNIQUE 约束
2. 或使用 SELECT FOR UPDATE 锁
3. 添加并发测试用例

**影响范围**: 仅认证模块，已有并发测试覆盖

---

### T3: 加固默认配置 - 确保生产环境不使用弱密钥

**问题**: `app/config.py` 可能包含弱默认密钥

**解决方案**:
1. 确保所有敏感配置在生产环境强制从环境变量读取
2. 添加启动时校验逻辑

**影响范围**: 配置模块

---

## ⚠️ 重要说明

**当前项目状态**:
- ✅ **Free Beta READY** - 可立即分发 Android APK 测试
- 🔴 **Production BLOCKED** - 被域名和 Apple Developer 账号阻塞

**以上任务均为加固优化项，不影响核心功能**

如果老板希望保持当前稳定状态，这些任务可以延后到 Production 阶段再做

---

## 🔄 执行状态

- **开始时间**: 2025-12-25 04:00
- **完成时间**: 2025-12-25 04:30
- **当前任务**: 无（全部完成）
- **完成任务**: 3/3（安全加固任务）
- **最后更新**: 2025-12-25 04:30

### 执行记录

| 时间 | 任务 | 状态 | 说明 |
|------|------|------|------|
| 04:05 | T1 Prompt Injection | ✅ Done | +3 tests, Unicode/分词防护 |
| 04:15 | T2 设备限制并发 | ✅ Done | +1 test, FOR UPDATE 锁 |
| 04:25 | T3 配置校验 | ✅ Done | +3 tests, lifespan 启动校验 |
| 04:28 | Git Push | ✅ Done | commit 2237aed (#119) |

### 测试结果

```
============================= 113 passed in 17.51s =============================
mypy: Success: no issues found in 40 source files
ruff: All checks passed!
```
